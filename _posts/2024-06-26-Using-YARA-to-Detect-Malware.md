# YARA Report and Demonstration

YARA is “the pattern matching swiss knife for malware researchers (and everyone else)” as stated on the YARA website/documentation, simply put, YARA is a tool primarily used in malware research that allows researchers to create descriptions of malware families based on textual or binary patterns. These descriptions, known as YARA rules, help identify and classify malware by specifying patterns to look for in files. YARA rules are often integrated into various tools and platforms to automatically scan file to identify potential malware.

### **Important Note**

Before we start creating some basic YARA rule, it is important to note that if you follow along, we are dealing with live malware that can damage your host system. Therefore, you should take basic precautions such as using a virtual machine (VM) like FLARE VM, disconnected from your local network or a sandboxed environment. 

<br>

### **Creating a Basic YARA Rule**

Let’s start by creating a very simply YARA rule that always returns true, meaning if you use this rule against any file, it will always match said file. To start off, open a text editor, such as Notepad++, and enter the following text seen in the screenshot below:

<img width="288" height="186" alt="Image" src="https://github.com/user-attachments/assets/8c5eee4c-d02a-44f3-a8a3-f371cab01468" />

The text after ‘rule’ denotes the name of the rule, and ‘condition: true’ means that this will match any file it is checked against. Save this file in the same directory as your downloaded YARA binary, and open a terminal or command prompt in that directory. To run the rule, enter:

<img width="563" height="177" alt="Image" src="https://github.com/user-attachments/assets/20cf9a9d-5162-4c98-9f8b-a3e3bf9436e5" />

The output indicates that this rule matched all files in the current directory.

<br>

### **Practical Example: Detecting WannaCry**

Let’s create a more practical YARA rule to detect WannaCry, an infamous piece of ransomware from 2017. You can file WannaCry samples on several malware sharing platforms such as vxunderground. First off, I am going to use floss, which is a tool created by Mandiant that extracts strings from malware. The purpose being that we want to identify interesting strings in the WannaCry sample:

<img width="477" height="78" alt="Image" src="https://github.com/user-attachments/assets/bd5f616d-f436-4135-b47e-56fd7f832fe6" />

Or:

<img width="799" height="64" alt="Image" src="https://github.com/user-attachments/assets/9bc4ae48-a4d8-419d-8a29-b4913fa4977f" />

The syntax is simply floss followed by the malware binary. The output is very long, making it likely beneficial to use the second command example to only extract strings of a larger length. The output indicates several strings unique to this ransomware which are interesting, these include (but not limited to):
- WanaCrypt0r
- http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com (kill switch for the malware)
- C:\%s\qeriuwjhrf
- cmd.exe /c "%s"
- WNcry@2ol7
Using some of these strings, we can write a YARA rule to identify WannaCry:

<img width="940" height="330" alt="Image" src="https://github.com/user-attachments/assets/54f73d78-737c-489c-baeb-a1fd82b471ed" />

This rule is more detailed than the previous one, it includes the following sections:
- Meta: Contains metadata about the rule, such as the author and description. 
- Strings: Lists the strings that are unique to WannaCry. 
- Condition: Specifies that the rule will match a file if it contains 1 or more of the three strings. 
To test this rule out, save the rule file and run:

<img width="940" height="143" alt="Image" src="https://github.com/user-attachments/assets/77a9f4fe-6e6e-4f91-ad77-193c1a0db054" />

As you can see, we have appended the -s switch which tells us that strings the rule has matched against. 

<br>

### **“Advanced Example”: Checking for PE Files**

It is important to understand that you can include multiple rules in one file. To demonstrate this, let’s create a rule to check if a file is a portable executable (PE) along with if it contains strings found in the WannaCry sample:

<img width="940" height="518" alt="Image" src="https://github.com/user-attachments/assets/5fdb3361-f95e-4a2f-8d2d-5bd7d351d3d0" />

The ‘IsPe’ rule checks if the PE signature found at offset ‘0x3C’ matches the MZ signature (0x5A4D which is hex for MZ). Run the rule file against the WannaCry sample to see if it matches both:

<img width="940" height="157" alt="Image" src="https://github.com/user-attachments/assets/f0ac770a-715c-4d99-bc3e-86aee6b6ddb4" />

The output shows us that it matched against the IsPe and WannaCry rule, indicating that it is a portable executable and WannaCry ransomware. The IsPe rule is beneficial for 99% of malware samples, as the majority of malware is PE. The IsPe rule can also help prevent false positives. To explain this, take for example a report on WannaCry, it would likely contain the strings we have used in the rule. If the IsPe rule/check was not used, it would match the file, even though it is not actually malware. 

<br>

### **Conclusion**

This short report demonstrates YARA in a simple and understandable way. I created this to explain and demonstrate YARA in a manner which would have greatly benefited me weeks ago. While these examples provide a basic introduction to YARA, real-world YARA rules are typically much more complex and require a deep understanding of the patterns you want to search for. To gain a comprehensive understanding of YARA, please check out the documentation found here. 
YARA rules are easy to pick up but challenging to master. The effectiveness of your rules depends on your understanding of the malware patterns you are targeting. 
